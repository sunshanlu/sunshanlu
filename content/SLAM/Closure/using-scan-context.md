---
authors: 孙善路-github, 孙善路-bilibili
title: `FAST-LIVO2重定位和回环思路`
tags: SLAM
date: 2025-03-01
slug: using-scan-context++
Category: SLAM, 回环检测
description: `Scan Context` 和 `Scan Context++`算法说明
---

## 背景

在最近的项目开展中，我负责速腾`M1`激光雷达和森云相机`SG2-AR0233`实现带有回环和重定位功能的融合`SLAM`算法开发。我自主改进了`Scan Context++`算法，并根据最新开源的`FAST-LIVO2`系统特性，开发了高效的回环闭合和重定位功能，这里对`Scan Context++`算法的改进过程和适配`FAST-LIVO2`特性的重定位和回环功能逻辑进行记录，下图是项目使用的传感器平台照片。

<div align='center'>
    <image src="../images/sensors.png" alt="`Scan Context`算法流程" width=800px/>
</div>

## 修改`Scan Context++`算法

根据我对`Scan Context++`算法的分析和使用经验发现，`Polar Context`描述子检测到的回环往往更稳定且更多，而`Cart Context`描述子由于作用在笛卡尔坐标系中，受到旋转干扰时，`Cart Context`往往不能检测出回环情况，但`Cart Context`描述子距离计算往往能得到平移初始值。因此在回环候选寻找阶段，我仅使用`PC`描述子而不使用`CC`描述子，这样可以避免由于旋转问题导致`CC`描述子鲁棒性不高的问题，当`PC`描述子检测到候选回环时，根据`PC`描述子给出的旋转初始值估计$R_{cq}$，将当前激光雷达帧旋转到候选雷达帧对应位置后，构造当前帧的`Cart Context`描述子，然后根据构造的当前帧新`CC`描述子和回环候选的`CC`描述子进行匹配计算得到平移估计初始值$t_{cq}$。修改后的算法流程如下。


<div align='center'>
    <image src="../images/scan_context_modify.png" alt="`Scan Context`算法流程" width=800px/>
</div>

- `Bin`编码过程分为`PC`极坐标编码和`CC`笛卡尔坐标编码；
- `PC`描述子构建过程与`Scan Context`算法保持一致；
- 增强`PC`描述子过程对应`Scan Context`论文中的`Root Shift`过程
- `Ring key`计算过程与`Scan Context`算法保持一致；
- 数据库`kdtree`对应的索引由`Ring key`描述，而内容保存增强`PC`描述子以及对应相对平移量、CC描述子和位姿；
- 最近回环候选寻找由`kdtree`根据`Ring Key`检索给出；
- `sector key`计算估计初始值过程与`Scan Context`算法保持一致；
- `PC`描述子计算实际n与`Scan Context`算法保持一致；
- 根据`PC`估计的$R_{cq}$计算去旋转`CC`描述子和当前状态`CC`描述子；
- `row key`和`col key`计算，其实是行方向平均$L_1$范数，列方向平均$L_1$范数计算对应的列向量和行向量，然后使用`Scan Context++`算法描述的最小描述符距离计算得到最小值对应的行偏移索引和列偏移索引；
- 使用行偏移索引和列偏移索引计算两个`CC`描述符对应邻域内的最小值，然后根据`CC`描述子的分辨率获得估计的平移向量。而初始的旋转角度由`PC`描述子距离计算给出。

## `FAST-LIVO2`回环闭合功能和重定位功能

<div align='center'>
    <image src="../images/loop_closure.png" alt="`Scan Context`算法流程" width=800px/>
</div>

我使用子地图策略实现`FAST-LIVO2`的回环闭合和全局重定位功能。上图描述的是回环闭合和重定位功能主要包含以下几个方面：

- 子地图结构和保存逻辑（保存时机、保存内容）
- 子地图之间的点云配准和点云与子地图之间的配准逻辑
- 回环闭合功能开始逻辑，对于回环闭合功能，当检测到的回环和当前帧之间不在同一子地图时，回环闭合功能开始
- 全局重定位功能逻辑，全局重定位逻辑主要是在已有子地图保存文件基础上，系统开始时做的重定位逻辑，确定当前帧与回环子地图之间的相对位姿
- 子地图状态更新逻辑，当子地图之间位姿图优化完成后，需要将每个子地图内部对应的点云帧位姿进行更新、平面点更新、平面法向量更新，基于位姿变换更新，更新逻辑比较简单。

### 子地图结构和保存逻辑

下面图是我截取的`FAST-LIVO2`的局部地图的管理逻辑，其中区域`A`和区域`B`组成了上一时刻的局部地图，区域`B`和区域`C`组成这一时刻的局部地图。**在区域`A`析构前**，需要对区域`A`和区域`B`组成的之前的局部地图进行磁盘**永久保存**。主要保存内容有：

- 体素内平面中心点，用于子地图之间的配准；
- 体素内平面法向量，用于子地图之间的配准；
- 局部地图内包含的点云帧`id`信息和位姿信息，用于`scan context++`构造的点云之间位姿初值向子地图之间位姿转换；
- 局部地图内包含的点云帧对应的`PC`描述子、`PC`增强描述子、`CC`描述子，用于当前点云帧的`scan context++`候选回环检测；

<div align='center'>
    <image src="../images/save_stragy.png" alt="`Scan Context`算法流程" width=800px/>
</div>

### 子地图之间的配准逻辑和点云与子地图配准逻辑

当回环闭合开始时，当使用改进的`scan context++`算法获取数据库回环候选的点云帧后，根据改进的`scan context++`算法，可以拿到初始的描述当前点云帧和回环候选点云帧之间的旋转矩阵和平移向量，将这部分相对位姿转换到对应的两个子地图下。使用**双向映射**的点到面的ICP算法，实现子地图之间的配准逻辑。

当`SLAM`系统开始时，需要寻找当前点云在之前地图中的位姿信息，当使用改进`scan context++`算法获取到候选回环点云后，加载子地图并构建点到面的`ICP`问题，并使用`huber`核函数估计当前帧与候选回环子地图的相对位姿关系。
